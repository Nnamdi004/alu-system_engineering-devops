#!/usr/bin/env bash
# This script installs Nginx and configures a permanent (301) redirection
# from /redirect_me to a target URL.
# This version uses a single-line sed command with escaped newlines (\n) to avoid
# SC1004 shell check warnings, while fulfilling the requirement to replace a line
# with multiple lines.

# Define the target redirection URL
REDIRECT_URL="https://www.youtube.com/watch?v=QH2-TGUlwu4"
NGINX_CONF_FILE="/etc/nginx/sites-available/default"
CUSTOM_CONTENT="Holberton School for the win!"

# --- 1. Update and Install Nginx ---

echo "Updating package lists and installing Nginx..."
sudo apt-get update -y
sudo apt-get install nginx -y

# --- 2. Configure Custom Index Page (from 1-install_nginx_web_server) ---

INDEX_FILE="/var/www/html/index.html"
echo "Creating custom index page..."
echo "$CUSTOM_CONTENT" | sudo tee "$INDEX_FILE" > /dev/null

# --- 3. Add 301 Redirection using sed ---

echo "Configuring 301 redirection in Nginx..."

# Escape the REDIRECT_URL to be safe inside the sed command
# This replaces all forward slashes (/) with escaped forward slashes (\/)
REDIRECT_URL_ESCAPED="${REDIRECT_URL//\//\\/}"

# Define the entire block that will replace the 'server_name _;' line.
# We use '\\n' for newlines and '\\t' for tabs (for indentation), all within a single quote block.
# The 'c' command replaces the matched line with the content of this string.
INSERT_BLOCK="server_name _;\\n\\n\tlocation /redirect_me {\\n\t\treturn 301 ${REDIRECT_URL_ESCAPED};\\n\t}"

# Apply the change
# /pattern/c content: Change (replace) the matched line with the content.
sudo sed -i "/server_name _;/c ${INSERT_BLOCK}" "$NGINX_CONF_FILE"

# --- 4. Restart Nginx (without systemctl) ---

echo "Restarting Nginx service to apply changes..."
# The 'service' command is used as an alternative to systemctl.
sudo service nginx restart

echo "Nginx configuration complete. Redirection from /redirect_me to $REDIRECT_URL is set."
