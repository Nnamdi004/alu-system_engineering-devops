#!/usr/bin/env bash
# This script installs Nginx and configures a permanent (301) redirection
# from /redirect_me to a target URL, using 'sed' to replace a line with multiple lines.

# Define the target redirection URL
REDIRECT_URL="https://www.youtube.com/watch?v=QH2-TGUlwu4"
NGINX_CONF_FILE="/etc/nginx/sites-available/default"
CUSTOM_CONTENT="Holberton School for the win!"

# --- 1. Update and Install Nginx ---

echo "Updating package lists and installing Nginx..."
sudo apt-get update -y
sudo apt-get install nginx -y

# --- 2. Configure Custom Index Page (from 1-install_nginx_web_server) ---

INDEX_FILE="/var/www/html/index.html"
echo "Creating custom index page..."
echo "$CUSTOM_CONTENT" | sudo tee "$INDEX_FILE" > /dev/null

# --- 3. Add 301 Redirection using sed ---

echo "Configuring 301 redirection in Nginx..."

# The sed 'c' command is used here to *change* (replace) the matched line 
# (server_name _;) with multiple lines: the original line itself, a blank line, 
# and the entire 'location' block for the 301 redirect.
# The backslashes are used to continue the 'c' command across multiple lines.
# This fulfills the requirement to "Replace a line with multiple lines with sed".

sudo sed -i '/server_name _;/ c\
        server_name _;\
\
        location /redirect_me {\
                return 301 '"$REDIRECT_URL"';\
        }' "$NGINX_CONF_FILE"

# The command above targets the `server_name _;` line and replaces it with:
# 1. server_name _;
# 2. (Empty line)
# 3. location /redirect_me { ... } (The redirect block)

# --- 4. Restart Nginx (without systemctl) ---

echo "Restarting Nginx service to apply changes..."
# The 'service' command is used as required instead of systemctl.
sudo service nginx restart

echo "Nginx configuration complete. Redirection from /redirect_me to $REDIRECT_URL is set."
